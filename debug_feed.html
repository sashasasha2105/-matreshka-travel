<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–µ–±–∞–≥ –ª–µ–Ω—Ç—ã</title>
    <style>
        body {
            background: #0f0520;
            color: #fff;
            font-family: monospace;
            padding: 20px;
            line-height: 1.6;
        }
        .section {
            background: #1a0a3a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            border: 2px solid #ffcc00;
        }
        button {
            padding: 12px 24px;
            margin: 10px 5px;
            border: none;
            border-radius: 5px;
            background: #ffcc00;
            color: #000;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }
        button:hover {
            background: #ff8e53;
        }
        pre {
            background: #0a0515;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
            font-size: 12px;
        }
        .error { color: #ff5555; }
        .success { color: #50fa7b; }
        .warning { color: #ffb86c; }
        img {
            max-width: 200px;
            max-height: 200px;
            border: 2px solid #ffcc00;
            margin: 5px;
        }
    </style>
</head>
<body>
    <h1>üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ª–µ–Ω—Ç—ã –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–π</h1>

    <div class="section">
        <h2>–¢–µ—Å—Ç—ã</h2>
        <button onclick="checkLocalStorage()">1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å localStorage</button>
        <button onclick="checkIndexedDB()">2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å IndexedDB</button>
        <button onclick="renderFeedTest()">3. –¢–µ—Å—Ç —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –ª–µ–Ω—Ç—ã</button>
        <button onclick="addTestTravel()">4. –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ</button>
        <button onclick="clearAll()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
    </div>

    <div class="section">
        <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h2>
        <pre id="output">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏...</pre>
    </div>

    <div class="section">
        <h2>–ü—Ä–µ–≤—å—é —Ñ–æ—Ç–æ</h2>
        <div id="photos" style="display: flex; flex-wrap: wrap;"></div>
    </div>

    <script>
        function log(text, type = 'normal') {
            const output = document.getElementById('output');
            let color = '#fff';
            if (type === 'error') color = '#ff5555';
            if (type === 'success') color = '#50fa7b';
            if (type === 'warning') color = '#ffb86c';

            output.innerHTML += `<span style="color:${color}">${text}</span>\n`;
            output.scrollTop = output.scrollHeight;
        }

        function clearOutput() {
            document.getElementById('output').textContent = '';
            document.getElementById('photos').innerHTML = '';
        }

        function checkLocalStorage() {
            clearOutput();
            log('=== –ü–†–û–í–ï–†–ö–ê localStorage ===\n', 'success');

            const key = 'matryoshka_all_travels';
            const data = localStorage.getItem(key);

            if (!data) {
                log(`‚ùå –ö–ª—é—á "${key}" –Ω–µ –Ω–∞–π–¥–µ–Ω!`, 'error');
                return;
            }

            log(`‚úÖ –ù–∞–π–¥–µ–Ω –∫–ª—é—á "${key}"`, 'success');
            log(`üì¶ –†–∞–∑–º–µ—Ä: ${(data.length / 1024).toFixed(2)} KB\n`);

            try {
                const parsed = JSON.parse(data);
                log(`‚úÖ –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏–π: ${parsed.length}\n`, 'success');

                parsed.forEach((t, i) => {
                    log(`\n${i + 1}. "${t.title}"`);
                    log(`   ID: ${t.id}`);
                    log(`   GlobalID: ${t.globalId || '–Ω–µ—Ç'}`);
                    log(`   –ê–≤—Ç–æ—Ä: ${t.author?.firstName || '–Ω–µ—Ç'}`);
                    log(`   –°–æ–∑–¥–∞–Ω–æ: ${new Date(t.createdAt).toLocaleString()}`);

                    if (t.images && t.images.length > 0) {
                        log(`   ‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: ${t.images.length}`, 'success');
                        log(`   –ü–µ—Ä–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: ${t.images[0].substring(0, 60)}...`);
                        log(`   –î–ª–∏–Ω–∞: ${(t.images[0].length / 1024).toFixed(2)} KB`);

                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤–æ–µ —Ñ–æ—Ç–æ
                        const photosDiv = document.getElementById('photos');
                        const img = document.createElement('img');
                        img.src = t.images[0];
                        img.title = t.title;
                        photosDiv.appendChild(img);
                    } else {
                        log(`   ‚ùå –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: 0`, 'error');
                    }
                });

            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: ${error.message}`, 'error');
            }
        }

        function checkIndexedDB() {
            clearOutput();
            log('=== –ü–†–û–í–ï–†–ö–ê IndexedDB ===\n', 'success');

            const request = indexedDB.open('MatryoshkaDB', 1);

            request.onerror = () => {
                log('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è IndexedDB', 'error');
            };

            request.onsuccess = (event) => {
                const db = event.target.result;
                log('‚úÖ IndexedDB –æ—Ç–∫—Ä—ã—Ç–∞\n', 'success');

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º travels
                const tx = db.transaction(['travels'], 'readonly');
                const store = store.objectStore('travels');
                const getAllRequest = store.getAll();

                getAllRequest.onsuccess = () => {
                    const travels = getAllRequest.result;
                    log(`‚úÖ –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏–π –≤ IndexedDB: ${travels.length}\n`, 'success');

                    travels.forEach((t, i) => {
                        log(`\n${i + 1}. "${t.title}"`);
                        log(`   ID: ${t.id}`);
                        log(`   –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: ${t.images?.length || 0}`);
                    });
                };

                getAllRequest.onerror = () => {
                    log('‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è travels', 'error');
                };
            };
        }

        function renderFeedTest() {
            clearOutput();
            log('=== –¢–ï–°–¢ –†–ï–ù–î–ï–†–ò–ù–ì–ê ===\n', 'success');

            const data = localStorage.getItem('matryoshka_all_travels');
            if (!data) {
                log('‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∞', 'error');
                return;
            }

            const travels = JSON.parse(data);
            log(`–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏–π –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∞: ${travels.length}\n`, 'success');

            travels.forEach((travel, i) => {
                log(`\n${i + 1}. –†–µ–Ω–¥–µ—Ä–∏–º "${travel.title}":`);

                const hasImages = travel.images && Array.isArray(travel.images) && travel.images.length > 0;
                log(`   –ü—Ä–æ–≤–µ—Ä–∫–∞ hasImages: ${hasImages}`, hasImages ? 'success' : 'error');

                if (hasImages) {
                    log(`   ‚úÖ –ë—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–æ ${travel.images.length} —Ñ–æ—Ç–æ`, 'success');

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ç–æ
                    const photosDiv = document.getElementById('photos');
                    travel.images.forEach((img, idx) => {
                        const imgEl = document.createElement('img');
                        imgEl.src = img;
                        imgEl.title = `${travel.title} - —Ñ–æ—Ç–æ ${idx + 1}`;
                        photosDiv.appendChild(imgEl);
                    });
                } else {
                    log(`   ‚ùå –§–æ—Ç–æ –ù–ï –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–æ!`, 'error');
                }
            });
        }

        function addTestTravel() {
            clearOutput();
            log('=== –î–û–ë–ê–í–õ–ï–ù–ò–ï –¢–ï–°–¢–û–í–û–ì–û –ü–£–¢–ï–®–ï–°–¢–í–ò–Ø ===\n', 'success');

            // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–µ —Ç–µ—Å—Ç–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ 100x100 –∫—Ä–∞—Å–Ω—ã–π –∫–≤–∞–¥—Ä–∞—Ç
            const canvas = document.createElement('canvas');
            canvas.width = 100;
            canvas.height = 100;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#ff0000';
            ctx.fillRect(0, 0, 100, 100);
            ctx.fillStyle = '#fff';
            ctx.font = '20px Arial';
            ctx.fillText('TEST', 25, 55);
            const testImage = canvas.toDataURL('image/jpeg', 0.8);

            const testTravel = {
                id: Date.now(),
                globalId: `test-${Date.now()}`,
                title: '–¢–µ—Å—Ç–æ–≤–æ–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ ' + new Date().toLocaleTimeString(),
                text: '–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã –ª–µ–Ω—Ç—ã',
                images: [testImage],
                createdAt: Date.now(),
                author: {
                    id: 'test_user',
                    firstName: '–¢–µ—Å—Ç',
                    lastName: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'
                },
                likes: 0,
                liked: false
            };

            log('‚úÖ –°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π –æ–±—ä–µ–∫—Ç', 'success');
            log(`–†–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ${(testImage.length / 1024).toFixed(2)} KB\n`);

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º
            const existing = localStorage.getItem('matryoshka_all_travels');
            const travels = existing ? JSON.parse(existing) : [];
            travels.unshift(testTravel);

            try {
                localStorage.setItem('matryoshka_all_travels', JSON.stringify(travels));
                log('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ localStorage!', 'success');
                log('\n–¢–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–µ–Ω—Ç—É –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏', 'warning');
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${error.message}`, 'error');
            }
        }

        function clearAll() {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ?')) {
                localStorage.clear();
                indexedDB.deleteDatabase('MatryoshkaDB');
                clearOutput();
                log('‚úÖ –í—Å—ë –æ—á–∏—â–µ–Ω–æ!', 'success');
            }
        }
    </script>
</body>
</html>
